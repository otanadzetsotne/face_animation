# SadTalker

Скрипт установки проекта - `additional_files/SadTalker/setup.sh`

## Проблемы
* Невозможно запустить на mps

## Логи работы
* Создал скрипт установщик проекта `additional_files/SadTalker/setup.sh`
* Загрузил необходимые модели (Необходимо 2.3Gb)
* Пытался исправить проблему активации conda окружении из скрипта, но не получилось.
  В итоге установил зависимости руками
* Доработал проект локально для запуска на `mps` так как на `cpu` процесс выполнялся долго.
* Столкнулся с проблемой `torchvision.transforms.functional_tensor`.
  Проблема в бибилиотете `torchvision`. Исправил установкой специфической версии `torchvision==0.16.0`
* Столкнулся с проблемой отсутсвия бэкенда для `torch.nn.Conv3D` на `mps`.
  Пытался найти решение проблемы. В Pytorch о ней знают и вроде как сделали исправление, но не в каких билдах мне его найти не удалось.
  Флаг `PYTORCH_ENABLE_MPS_FALLBACK=1` в данном случае по какой то причине тоже не работает.
  Добавил в проект костыли которые прокидывали тензоры на `cpu` для операций `torch.nn.Conv3D` и обратно.
* Столкнулся с новой проблемой: 
  ```
  RuntimeError: slow_conv2d_forward_mps: input(device='cpu') and weight(device=mps:0') must be on the same device
  ```
  Понял, что для ее решения нужно идти в глубь самого torch, что могло занять много времени.
  Поэтому решил вернуться к запуску моделей на `cpu`, так как ожидал, что это будет быстрее, чем пытаться исправить эту проблему.
* На cpu процесс генерации видео занял 20 минут. Имя итогового файла `sadtalker__still__preprocess_full.mp4`
  Для запуска процесса использовалась команда:
  ```
  python inference.py --driven_audio tmp/YandexSample.wav \
                      --source_image tmp/photo.png \
                      --result_dir tmp \
                      --still \
                      --preprocess full
  ```
  Необходимо протетсировать разные конфигурации запуска.
* Процесс генерации с `--enhancer gfpgan` занял около 30 минут.
  Улучшилось качество и разрешение видео, но в остальном все так же.
